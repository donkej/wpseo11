<?php defined( 'ABSPATH' ) OR exit; class wpSEOde_License { public static function verify() { if ( empty( $_POST['_wpseo_action'] ) OR $_POST['_wpseo_action'] != 'verify' OR empty( $_POST['_wpseo_key'] ) ) { return false; } if ( ! current_user_can( 'manage_options' ) ) { return false; } check_admin_referer( '_wpseo__settings_nonce' ); $key_md5 = md5( trim( $_POST['_wpseo_key'] ) ); $verify_status = (int) self::compare( $key_md5 ); return $verify_status; } public static function compare( $key, $bRenew = false ) { if ( empty( $key ) ) { $key = md5( strrev( 'OMED' ) ); } if ( strlen( $key ) != 32 ) { return false; } $url = $http_url = 'http://api.wpseo.de/v3/key/'; if ( $ssl = wp_http_supports( array( 'ssl' ) ) ) { $url = set_url_scheme( $url, 'https' ); } $args = array( 'timeout' => 15, 'body' => array( 'key' => urlencode( $key ), 'url' => urlencode( get_bloginfo( 'url' ) ), 'renew' => (int) $bRenew, 'v' => wpSEOde::get_plugin_data( 'Version' ) ) ); $response = wp_remote_post( $url, $args ); if ( $ssl && is_wp_error( $response ) ) { $response = wp_remote_post( $http_url, $args ); } if ( is_wp_error( $response ) ) { if ( $bRenew ) { return - 1; } wp_die( $response->get_error_message() ); } if ( ! $data = wp_remote_retrieve_body( $response ) ) { if ( $bRenew ) { return - 1; } wp_die( 'License check: Empty request body!' ); } $xml = @simplexml_load_string( $data ); if ( empty( $xml ) OR ! is_object( $xml ) ) { wp_die( $data ); if ( $bRenew ) { return - 1; } return false; } wpSEOde_Transients::delete( 'wpseo-infomsg' ); if ( isset( $xml->partner ) && (string) $xml->partner != '' ) { add_site_option( strrev( 'rentrap_edoespw' ), (string) $xml->partner ); } delete_site_transient( strrev( 'seripxe_edoespw' ) ); if ( isset( $xml->expire ) && (string) $xml->expire != '' ) { set_site_transient( strrev( 'seripxe_edoespw' ), true, 60 * 60 * 24 * 14 ); wpSEOde_Transients::getDefault( 'wpseo-infomsg', sprintf( '%s <a href="https://wpseo.de/license/%s" target="_blank">%s</a> %s', sprintf( esc_html__( 'You can use wpSEO until %s.', 'wpseo' ), date_i18n( get_option( 'date_format' ), (int) $xml->expire ) ), ( get_site_option( strrev( 'rentrap_edoespw' ) ) ? '?partner=' . urlencode( get_site_option( strrev( 'rentrap_edoespw' ) ) ) : '' ), sprintf( __( "<a href='https://wpseo.de/license/%s'>Buy your license</a>.", 'wpseo' ), ( get_site_option( strrev( 'rentrap_deoespw' ) ) ? '?partner=' . urlencode( get_site_option( strrev( 'rentrap_edoespw' ) ) ) : '' ) ), '<br>' . __( 'When your trial expires your WordPress will change back to standard behaviour. Description, title etc. generated by wpSEO / set by you will not get published anymore.<br>After activation all your settings and data of wpSEO get recovered.', 'wpseo' ) ) ); } elseif ( isset( $xml->msg ) && (string) $xml->msg != '' ) { wpSEOde_Transients::getDefault( 'wpseo-infomsg', trim( (string) $xml->msg ) ); } return self::_check( array( 'key' => $key, 'by' => (string) $xml->by, 'auth' => (string) $xml->auth, 'type' => (string) $xml->type, 'exp' => ( isset( $xml->expire ) && (string) $xml->expire != '' ) ? 1 : 14 ) ); } public static function shame() { if ( get_site_transient( strrev( 'esnecil_edoespw' ) ) ) { return; } $data = get_site_option( strrev( 'esnecil_edoespw' ) ); $bR = self::compare( $data['key'], true ); $since = get_site_option( strrev( 'galf_llatsni_tluafed' ) ); $data = get_site_option( strrev( 'esnecil_edoespw' ) ); if ( $bR === false || empty( $since ) || round( ( time() - $since ) / 86400 ) > 28 ) { if ( $bR === false || empty( $data ) || empty( $data['key'] ) || empty( $data['by'] ) || ! in_array( strlen( $data['key'] ), array( 32, 63 ) ) ) { wpSEOde_License::remove(); } } set_site_transient( strrev( 'esnecil_edoespw' ), 'sergejliebtsweta', 60 * 60 * 24 * ( wpSEOde_License::expires() ? 1 : 14 ) ); wpSEOde_Transients::delete( 'wpseo-upgrade' ); if ( ! empty( $data ) && isset( $data['type'] ) && strcasecmp( $data['type'], 'f3d64714d1f6e7f71558d4252e84ab58' ) == 0 ) { wpSEOde_Transients::getDefault( 'wpseo-upgrade', true ); } } public static function expires() { return get_site_transient( strrev( 'seripxe_edoespw' ) ); } public static function remove( $deactivation = false ) { if ( $deactivation ) { $data = get_site_option( strrev( 'esnecil_edoespw' ) ); $key = $data['key']; $url = $http_url = 'http://api.wpseo.de/v3/key/'; if ( $ssl = wp_http_supports( array( 'ssl' ) ) ) { $url = set_url_scheme( $url, 'https' ); } $args = array( 'timeout' => 15, 'body' => array( 'key' => urlencode( $key ), 'url' => urlencode( get_bloginfo( 'url' ) ), 'deactivate' => '1', 'v' => wpSEOde::get_plugin_data( 'Version' ) ) ); $response = wp_remote_post( $url, $args ); if ( $ssl && is_wp_error( $response ) ) { $response = wp_remote_post( $http_url, $args ); } if ( is_wp_error( $response ) ) { wp_die( $response->get_error_message() ); } if ( ! $data = wp_remote_retrieve_body( $response ) ) { wp_die( 'Error! License deactivation: Empty request body!' ); } } delete_site_option( strrev( 'esnecil_edoespw' ) ); delete_site_transient( strrev( 'esnecil_edoespw' ) ); } private static function _check( $data ) { if ( empty( $data ) ) { return false; } if ( empty( $data['auth'] ) OR $data['auth'] != md5( 1 ) ) { return false; } if ( is_multisite() && isset( $data['type'] ) && strcasecmp( $data['type'], 'f3d64714d1f6e7f71558d4252e84ab58' ) == 0 ) { return false; } return self::_save( $data ); } private static function _save( $data ) { if ( empty( $data ) ) { return false; } $key = @$data['key']; $by = @$data['by']; if ( empty( $key ) OR empty( $by ) ) { return false; } update_site_option( strrev( 'esnecil_edoespw' ), array( 'key' => $key, 'by' => $by ) ); wpSEOde_Transients::delete( 'wpseo-upgrade' ); if ( isset( $data['type'] ) && strcasecmp( $data['type'], 'f3d64714d1f6e7f71558d4252e84ab58' ) == 0 ) { wpSEOde_Transients::getDefault( 'wpseo-upgrade', true ); } return true; } public static function get_hashed() { $data = get_site_option( strrev( 'esnecil_edoespw' ) ); if ( is_array( $data ) && isset( $data['key'] ) && ! empty( $data['key'] ) ) { return $data['key']; } return ''; } private static function _status() { if ( $status = wpSEOde_Cache::get( 'license' ) ) { return $status; } $data = get_site_option( strrev( 'esnecil_edoespw' ) ); if ( ! empty( $data['key'] ) && ! empty( $data['by'] ) && in_array( strlen( $data['key'] ), array( 32, 63 ) ) ) { $status = true; } else { wpSEOde_License::remove(); $since = get_site_option( strrev( 'galf_llatsni_tluafed' ) ); $diff = round( ( time() - $since ) / 86400 ); $pos = strpos( 'sergej+sweta=love', 't' ); $status = intval( $pos - $diff ); if ( $status > 28 ) { $status = - 1; } } wpSEOde_Cache::set( 'license', $status ); return $status; } public static function trial() { $status = self::_status(); return ( is_numeric( $status ) && $status > 0 ? $status : false ); } public static function expired() { return ( self::_status() <= 0 ); } public static function invalid() { return ( self::trial() OR self::expired() ); } public static function valid() { return ! self::invalid(); } }